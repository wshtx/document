[TOC]

#### 2-3-4树

2-3-4树是一种4阶B树，是一种自平衡的多路查找树，是对完美平衡二叉树的扩展。大部分编程语言直接实现2-3-4树非常繁琐，所以通过实现红黑树来替代2-3-4树。红黑树本身也能在O(logN)的时间内完成插入删除和查找。

##### 2-3-4树性质

- 每个节点分别有1,2,3个Key值，称为2(孩子)节点，3(孩子)节点，4(孩子)节点。
- 根节点到所有叶子结点的路径长度相同
- 每个节点的key从左到右保持升序

2-3-4树的查找与AVL逻辑类似。

##### 2-3-4树插入思路

​	**插入新节点时总是在叶子节点上新增节点**，这样会使得2节点变成3节点，3节点变成4节点，而4节点不能插入key，此时需要将4节点分裂并将中间的key推送给其父节点。分裂这个行为导致了2-3-4树的生长是自底向上的。4节点的分裂有自顶向下和自底向上两种处理思路：

- 自顶向上，从要插入的4节点开始分裂，如果分裂后其父节点也是父节点，继续分裂，直至根节点。
- 自顶向下，从根节点到插入的叶子结点路径上，遇到4节点就分裂

两种方法都能实现2-3-4树的插入，不过自顶向下不需要递归，实现更简单。

##### 2-3-4树自顶向下的插入逻辑 

1. 从根节点向下开始搜索，遇到4节点就分裂：1个4节点可以分裂成3个2节点，中间的2节点和父节点进行合并。

   此时的4节点分裂有三种情况：

   - 4节点是根节点；
   - 4节点的父节点是2节点；
   - 4节点的父节点是3节点；

   ###### 为啥不出现4节点的父节点是4节点的情况？

   答：因为自上而下的搜索，4节点的上面的存在4节点已经被分解过了。

   ![img](https://filescdn.proginn.com/2d118edc963481ce9eac87d1fa7eab0e/323d0a0f7852ee3bc19e252e5b037b67.webp)

2. 直至搜索到叶子节点，此时的插入节点只能是2节点或者3节点，直接插入key；

##### 2-3-4树删除思路

###### 删除思路

- 删除非叶子结点时，可以将该节点key替换为中序遍历的后继节点的key(删除节点右子树的最小key)，转换成**删除右子树最小key**的问题。
- 删除叶子结点时，如果叶子结点是3节点或者4节点，则可以直接删除key；如果叶子结点是2节点，则直接删除会影响树的平衡。所以难点在于如何删除2节点类型的叶子结点。

###### 如果删除2节点类型的叶子结点？

​	删除2节点类型的叶子结点，删除2节点会导致树平衡被破坏，为了避免这个情况，不能让删除发生在2节点上，所以自顶向下只要遇到2节点就将其转换为3节点或者4节点，这样删除2节点类型的叶子节点就可以转换成3节点或者4节点的安全删除。

​	2节点转换成3节点或者4节点有**合并**和**借**方法：

- 从兄弟节点借一个key和当前节点进行融合变成3节点；
- 将父节点，兄弟节点的key和当前节点全部合并成一个4节点；

下图展示2节点转换成3节点或者4节点的六种情况，其实简单分成两种情况即可：兄弟节点是2节点或兄弟节点是非2节点。

![img](https://upload-images.jianshu.io/upload_images/1234352-f927a676b1de85e4.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp)



###### 在上述方法中，为何合并的时候不直接将兄弟节点和删除节点合并呢，要多合并一个父节点的key？为何借节点的时候是将兄弟节点给父节点，父节点的key再借给删除节点？

答：因为2-3-4树本质上需要维护数据的有序性(节点内部的key或者节点之间key)，合并的时候直接将兄弟节点和删除节点合并(或者借节点的时候将节点直接借给删除节点)，会导致父节点的右子树并不总是大于父节点的key(或者其他情况)；

###### 在2节点转换成3节点或者4节点时，为什么只有6种情况：父节点是3节点或4节点，兄弟节点是2节点或3节点或4节点，2X3种，唯独少了父节点是2节点的情况？

答：类似插入时分裂4节点只有两种情况一样(4节点父节点是2节点或3节点，不算4节点没有父节点是根节点的情况)，都是因为是自顶向下进行处理，当前2节点的父节点如果是2节点则已经被转换成3节点或者4节点了。所以2节点的父节点不可能是2节点。

##### 2-3-4树自顶向下的删除逻辑

1. 从根节点开始命中搜索，如果遇到2节点，则视情况将**2节点转换成3节点或者4节点**；
2. 如果命中节点是非叶子结点，则用该节点的右子树最小key值替换该节点(中序遍历的后继节点)，转换为**删除该节点右子树最小key**；
3. 如果命中节点是叶子节点(必定是3节点或者4节点)，则直接删除key值；

###### 删除子树最小key逻辑

1. 从根节点开始沿着左连接开始搜索，如果遇到2节点，则将2节点转换成3节点或者4节点；
2. 搜索到最小key时，直接删除；

##### 参考链接：

[动画 | 什么是红黑树?(与2-3-4树等价)](https://jishuin.proginn.com/p/763bfbd235a9)
